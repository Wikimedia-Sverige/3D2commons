!function(e){"use strict";var t,a,n,s,o=window.i18n,i='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',r="rtl"===o["@dir"],d={abortbutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> '+Mustache.escape(o.abort)+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-trash"></span> '+Mustache.escape(o.remove)+"</button>",restartbutton:'<button type="button" class="btn btn-warning btn-xs flip pull-right"><span class="glyphicon glyphicon-repeat"></span> '+Mustache.escape(o.restart)+"</button>",loading:"<center>"+i+"&nbsp;&nbsp;"+Mustache.escape(o.loading)+"</center>",errorDisconnect:'<div class="alert alert-danger">'+Mustache.escape(o.errorDisconnect)+"</div>",yourTasks:"<h4>"+Mustache.escape(o.yourTasks)+'</h4><table id="tasktable" class="table"><tbody></tbody></table>',addTask:'<input class="btn btn-primary btn-success btn-md" type="button" accesskey="n" value="'+Mustache.escape(o.addTask)+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">'+Mustache.escape(o.createServerSide)+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:'<span class="glyphicon glyphicon-chevron-'+(r?"right":"left")+'"></span> '+Mustache.escape(o.back),nextbutton:Mustache.escape(o.next)+' <span class="glyphicon glyphicon-chevron-'+(r?"left":"right")+'"></span>',confirmbutton:Mustache.escape(o.confirm)+' <span class="glyphicon glyphicon-ok"></span>'},l="";o.a=function(){return function(e,t){if("#"===e[0]){var a=e.indexOf("|");if(a<0){if(/^[a-z0-9-]+$/i.test(e.slice(1)))return'<a id="'+e.slice(1)+'"></a>'}else if(/^[a-z0-9-]+$/i.test(e.substring(1,a)))return'<a id="'+e.substring(1,a)+'">'+t(e.slice(a+1))+"</a>"}return"<a>"+t(e)+"</a>"}};var c=window.threed2commons={init:function(){e("#content").html(d.loading),n={},c.loadCsrf(c.checkStatus);var t=/^#?!(https?:\/\/.+)/;t.test(window.location.hash)&&c.addTask({url:window.location.hash.match(t)[1]})},loadCsrf:function(t){e.get("api/csrf").done(function(e){l=e.csrf,t()})},checkStatus:function(){window.WebSocket&&window.io?c.checkStatusSocket():c.checkStatusLegacy()},checkStatusSocket:function(){if(!window.socket){var t=window.socket=io("//tools.wmflabs.org/",{path:"/threed2commons-socketio"});t.on("connect",function(){e.get("api/iosession").done(function(e){t.emit("auth",{iosession:e.iosession,_csrf_token:l})})}),t.on("status",function(e){c.alterTaskTableBoilerplate(function(){c.populateResults(e)})}),t.on("update",function(e,t){c.alterTaskTableBoilerplate(function(){c.updateTask(t)})}),t.on("remove",function(t){c.alterTaskTableBoilerplate(function(){e("#task-"+t).remove()})})}},checkStatusLegacy:function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);e.get("api/status").done(function(e){c.alterTaskTableBoilerplate(function(){c.populateResults(e)}),window.lastStatusCheck=setTimeout(c.checkStatusLegacy,5e3)}).fail(function(){e("#content").html(d.errorDisconnect)})},setupTables:function(){e("#content").html(d.yourTasks);var t=e(d.addTask);e("#content").append(t),t.click(function(){c.addTask()});var a=e(d.requestServerSide);e("#content").append(a.hide())},alterTaskTableBoilerplate:function(t){e("#tasktable").length||c.setupTables();var a=window.innerHeight+window.scrollY>=document.body.offsetHeight;t(),e.isEmptyObject(n)?e("#ssubtn").addClass("disabled").hide():e("#ssubtn").removeClass("disabled").show().attr("href",c.makeSSULink(n)),a&&window.scrollTo(0,document.body.scrollHeight)},populateResults:function(t){s=t.username;var a=e("#tasktable > tbody"),n=[];e.each(t.values,function(e,t){c.updateTask(t),n.push(t.id)}),a.find("> tr").each(function(){var t=e(this),a=c.getTaskIDFromDOMID(t.attr("id"));n.indexOf(a)<0&&t.remove()})},updateTask:function(t){var a=e("#tasktable > tbody"),s="task-"+t.id,i=e("#"+s);i.length?i.attr("status")!==t.status&&(i.html(""),c.setupTaskRow(i,s,t.status)):(e("#task-new").remove(),(i=e("<tr />")).attr({id:s,status:t.status}),a.append(i),c.setupTaskRow(i,s,t.status));var r=i.find("#"+s+"-title");r.text()!==t.title&&r.text(t.title);var d=function(e,t,a){var n=i.find("#"+s+"-statustext");if(t){var o=n.html(e).find("a").attr("href",t);a&&o.text(a)}else n.text()!==e&&n.text(e)};"done"===t.status?d(Mustache.render("{{> taskDone}}",o,o),t.url,t.text):"needssu"===t.status?d(Mustache.render("{{> errorTooLarge}}",o,o),c.makeSSULink([t])):"fail"===t.status?(d(t.text),t.restartable?i.find("#"+s+"-restartbutton").show().off().click(function(){c.eventTask(this,"restart")}):i.find("#"+s+"-restartbutton").off().hide()):d(t.text),"progress"===t.status&&c.setProgressBar(i.find("#"+s+"-progress"),t.progress),"needssu"===t.status?n[t.id]=t:delete n[t.id]},setupTaskRow:function(t,a,n){switch(n){case"progress":t.append(e("<td />").attr("id",a+"-title").attr("width","30%")).append(e("<td />").attr("id",a+"-status").attr("width","40%").append(e("<span />").attr("id",a+"-statustext"))).append(e("<td />").attr("id",a+"-progress").attr("width","30%"));var s=c.eventButton(a,"abort");t.find("#"+a+"-status").append(s);var o=t.find("#"+a+"-progress").html(d.progressbar);c.setProgressBar(o,-1),t.removeClass("success danger");break;case"done":c.appendButtons([c.eventButton(a,"remove")],t,["danger","success"],a);break;case"fail":var i=c.eventButton(a,"remove"),r=c.eventButton(a,"restart").hide();c.appendButtons([i,r],t,["success","danger"],a);break;case"needssu":c.appendButtons([c.eventButton(a,"remove")],t,["success","danger"],a);break;case"abort":c.appendButtons([],t,["success","danger"],a)}t.attr("status",n)},makeSSULink:function(t){var a=e.map(t,function(e){return"* "+e.url}).join("\n"),n=e.map(t,function(e){return"| "+e.filename+" | "+e.hashsum+" |"}).join("\n");return"https://phabricator.wikimedia.org/maniphest/task/edit/form/1/?"+e.param({title:"Server side upload for "+s,projects:"Wikimedia-Site-requests,commons,3D2commons",description:Mustache.render("Please upload these file(s) to Wikimedia Commons:\n\n**URLs**\n\n{{{ urls }}}\n\n//Description files are available too: append `.txt` to the URLs.//\n\n**Checksums**\n\n| **File** | **MD5** |\n{{{ checksums }}}\n\nThank you!",{urls:a,checksums:n})})},setProgressBar:function(e,t){var a=e.find(".progress-bar");t<0?(a.addClass("progress-bar-striped active").addClass("active").text(""),t=100):a.removeClass("progress-bar-striped active").text(Math.round(t)+"%"),a.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+t+"%"})},getTaskIDFromDOMID:function(e){return/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(e)[1]},eventTask:function(t,a){var n=e(t);n.is(".disabled")||(n.off().addClass("disabled"),c.apiPost("task/"+a,{id:c.getTaskIDFromDOMID(n.attr("id"))}).done(function(e){e.error&&window.alert(e.error),c.checkStatus()}))},setText:function(e,a){for(var n=0;n<e.length;n++)t.find("#"+e[n]).text(a[e[n]])},eventButton:function(t,a){return e(d[a+"button"]).attr("id",t+"-"+a+"button").off().click(function(){c.eventTask(this,a)})},appendButtons:function(t,a,n,s){a.append(e("<td />").attr("id",s+"-title").attr("width","30%"));var o=e("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(e("<span />").attr("id",s+"-statustext"));t.length&&o.append(t[0]);for(var i=1;i<t.length;i++)o.append(t[i]);a.append(o).removeClass(n[0]).addClass(n[1])},addTask:function(a){t?c.openTaskModal(a):e.get("static/html/addTask.min.html").success(function(n){(t=e("<div>").html(Mustache.render(n,o))).addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),e("body").append(t),t.find("#btn-prev").html(d.prevbutton),t.find("#btn-next").html(d.nextbutton),t.find("#btn-cancel").click(function(){c.abortUpload()}),t.find(".modal-body").keypress(function(a){13!==(a.which||a.keyCode)||e(":focus").is("textarea")||(t.find(".modal-footer #btn-next").click(),a.preventDefault())}),c.openTaskModal(a)})},openTaskModal:function(e){t.find("#dialog-spinner").hide(),t.find(".modal-body").html("<center>"+i+"</center>"),c.newTask(e),t.modal({backdrop:"static"}),t.on("shown.bs.modal",function(){t.find("#url").focus()}),c.reactivatePrevNextButtons()},newTask:function(t){a={step:"source",url:null,extractor:"",subtitles:!0,uploadToCommons:!0,uploadToSketchfab:!0,filename:null,date:null,creator:null,license:null,licenses:[],filedesc:"",uploadedFile:{},filenamechecked:!1,filedescchecked:!1},e.extend(a,t),c.setupAddTaskDialog()},setupAddTaskDialog:function(){switch(a.step){case"source":e.get("static/html/sourceForm.min.html").success(function(n){n=Mustache.render(n,o,o),t.find(".modal-body").html(n),e("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),e("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),e("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),e("a#3dpl").attr("href","//wikimediafoundation.org/wiki/Wikimedia_3D_file_patent_license"),e("a#3dfp").attr("href","//meta.wikimedia.org/wiki/Wikilegal/3D_files_and_3D_printing"),t.find("#url").val(a.url).focus(),t.find("#video").prop("checked",a.video),t.find("#audio").prop("checked",a.audio),t.find("#subtitles").prop("checked",a.subtitles),c.initUpload()});break;case"target":e.get("static/html/targetForm.min.html").success(function(n){n=Mustache.render(n,o),t.find(".modal-body").html(n),t.find("#filename").val(a.filename).focus(),e("#upload-to-commons").prop("checked",a.uploadToCommons),e("#upload-to-sketchfab").prop("checked",a.uploadToSketchfab),e("#date").val(a.date),null==a.creator?e.get("api/username").done(function(t){e("#creator").val(t.username)}):e("#creator").val(a.creator),e("#license").val(a.license),e.each(a.licenses,function(t,a){e("#license").append(e("<option></option>").text(a))}),t.find("#filedesc").val(a.filedesc)});break;case"confirm":e.get("static/html/confirmForm.min.html").success(function(e){e=Mustache.render(e,o),t.find(".modal-body").html(e),c.setText(["url","filename","date","source","creator","license"],a),t.find("#filedesc").val(a.filedesc),t.find("#btn-next").focus()})}},reactivatePrevNextButtons:function(){switch(t.find("#dialog-spinner").hide(),a.step){case"source":t.find("#btn-prev").addClass("disabled").off(),t.find("#btn-next").html(d.nextbutton),c.setPrevNextButton("next");break;case"target":c.setPrevNextButton("prev"),t.find("#btn-next").html(d.nextbutton),c.setPrevNextButton("next");break;case"confirm":c.setPrevNextButton("prev"),t.find("#btn-next").removeClass("disabled").html(d.confirmbutton).off().click(function(){c.disablePrevNext(!1),t.modal("hide"),e("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+i+"</td></tr>"),window.scrollTo(0,document.body.scrollHeight),a.uploadedFile={},c.apiPost("task/run",a).done(function(e){e.error&&window.alert(e.error),c.checkStatus()})})}},setPrevNextButton:function(e){t.find("#btn-"+e).removeClass("disabled").off().click(function(){c.processInput(e)})},disablePrevNext:function(e){t.find(".modal-body #dialog-errorbox").hide(),t.find("#btn-prev").addClass("disabled").off(),t.find("#btn-next").addClass("disabled").off(),e&&t.find("#dialog-spinner").show()},processInput:function(n){var s,o,i,r=e.when();switch(a.step){case"source":s=e.when(function(){t.find("#video").is(":checked"),t.find("#audio").is(":checked");return a.subtitles=t.find("#subtitles").is(":checked"),a.licenses.length?r:c.askAPI("licenses",{},["licenses","license"])}(),function(){var n=t.find("#url").val();if(!n)return e.Deferred().reject("URL cannot be empty!").promise();if(a.filename&&a.filedesc&&n===a.url)return r;a.filenamechecked=!1,a.filedescchecked=!1;var s=a.uploadedFile[n];return s?(a.url=n,c.askAPI("makedesc",{filename:s.name||""},["extractor","filedesc","filename"])):c.askAPI("extracturl",{url:n},["url","extractor","filedesc","filename"])}());break;case"target":s=e.when((i=t.find("#filename").val(),a.format=t.find("#format").val(),a.uploadToCommons=t.find("#upload-to-commons").is(":checked"),a.uploadToSketchfab=t.find("#upload-to-sketchfab").is(":checked"),a.date=e("#date").val(),a.source=e("#source").val(),a.creator=e("#creator").val(),a.license=e("#license").val(),i?a.filenamechecked&&i===a.filename?r:c.askAPI("validatefilename",{filename:i},["filename"]).done(function(){a.filenamechecked=!0}):e.Deferred().reject("Filename cannot be empty!").promise()),(o=t.find("#filedesc").val(),a.filedescchecked&&o===a.filedesc?r:c.askAPI("validatefiledesc",{filedesc:o},["filedesc"]).done(function(){a.filedescchecked=!0})));break;case"confirm":s=r}c.promiseWorkingOn(s.done(function(){var e={prev:-1,next:1}[n],t=["source","target","confirm"];a.step=t[t.indexOf(a.step)+e],c.setupAddTaskDialog()}))},promiseWorkingOn:function(a){return c.disablePrevNext(!0),a.fail(function(a){t.find(".modal-body #dialog-errorbox").length||t.find(".modal-body").append(e('<div class="alert alert-danger" id="dialog-errorbox"></div>')),t.find(".modal-body #dialog-errorbox").text("Error: "+a).show()}).always(c.reactivatePrevNextButtons)},abortUpload:function(e,t){e&&"pending"===e.state()&&e.reject(t),window.jqXHR&&window.jqXHR.abort()},initUpload:function(){var n;window.jqXHR=t.find("#fileupload").fileupload({dataType:"json",url:"/upload/upload",formData:{_csrf_token:l},maxChunkSize:4<<20,sequentialUploads:!0}).on("fileuploadadd",function(a,s){window.jqXHR=s.submit(),n=e.Deferred(),c.promiseWorkingOn(n.promise()),t.find("#src-url").hide(),t.find("#src-uploading").show(),t.find("#upload-abort").off().click(function(){c.abortUpload(n,"Upload aborted.")})}).on("fileuploadchunkdone",function(e,t){t.result.filekey&&(t.formData.filekey=t.result.filekey),"Continue"===t.result.result?t.result.offset!==t.uploadedBytes&&c.abortUpload(n,"Unexpected offset! Expected: "+t.uploadedBytes+" Returned: "+t.result.offset):t.result.error?c.abortUpload(n,t.result.error):c.abortUpload()}).on("fileuploadprogressall",function(e,a){c.setProgressBar(t.find("#upload-progress"),a.loaded/a.total*100)}).on("fileuploadalways",function(e,a){delete a.formData.filekey,c.reactivatePrevNextButtons(),t.find("#src-url").show(),t.find("#src-uploading").hide()}).on("fileuploadfail",function(){c.abortUpload(n,"Something went wrong while uploading... try again?")}).on("fileuploaddone",function(e,s){if("Success"===s.result.result){var o="uploads:"+s.result.filekey;a.uploadedFile[o]=s.files[0],t.find("#url").val(o),n.resolve()}else c.abortUpload(n,"Upload does not seem to be successful.")})},askAPI:function(t,n,s){var o=e.Deferred();return c.apiPost(t,n).done(function(e){if(e.error)o.reject(e.error);else{for(var t=0;t<s.length;t++)a[s[t]]=e[s[t]];o.resolve(e)}}).fail(function(){o.reject("Something weird happened. Please try again.")}),o.promise()},apiPost:function(t,a){return a._csrf_token=l,e.post("api/"+t,a)}};e(document).ready(function(){c.init()})}(jQuery);